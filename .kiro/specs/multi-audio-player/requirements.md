# 需求文档

## 简介

本项目是一个基于 Python Tkinter 的舞台剧音乐音效控制系统，专为现场演出设计。支持自动模式（按剧本预设顺序播放）和手动模式（根据演出实际情况灵活控制）。系统需要在演出过程中实现零卡顿切换、快速响应和可靠的断点恢复功能。

## 术语表

- **控制台 (Console)**: 本舞台剧音乐音效控制系统 GUI 应用程序
- **背景音乐 (BGM)**: 舞台剧场景的背景音乐，同一时间只能播放一首
- **音效 (SFX)**: 短促的声音效果，如门铃、雷声等，可与 BGM 同时播放
- **音频片段 (Cue)**: 音频文件中从指定开始时间到结束时间的一段内容
- **断点 (Breakpoint)**: 音频播放暂停时记录的播放位置，用于续播
- **静音间隔 (Silence Gap)**: 两个音频片段之间的静音等待时间
- **自动模式 (Auto Mode)**: 按剧本预设顺序自动播放的模式
- **手动模式 (Manual Mode)**: 操作员根据演出实际情况手动控制的模式
- **Cue 列表 (Cue List)**: 预设的音频播放序列配置

## 需求

### 需求 1

**用户故事:** 作为舞台音效操作员，我希望在自动模式下按剧本顺序播放音频，以便配合演出节奏。

#### 验收标准

1. WHEN 操作员启动自动模式播放 THEN 控制台 SHALL 按 Cue 列表顺序依次播放各音频片段
2. WHEN 控制台播放音频片段 THEN 控制台 SHALL 从指定的入点播放到指定的出点
3. WHEN 一个音频片段播放完成 THEN 控制台 SHALL 等待预设的静音间隔后播放下一片段
4. WHEN 多个音轨配置为同时播放 THEN 控制台 SHALL 同时播放这些音轨实现叠加效果

### 需求 2

**用户故事:** 作为舞台音效操作员，我希望在自动模式下能够实时干预播放，以便应对演出中的突发情况。

#### 验收标准

1. WHEN 操作员点击暂停按钮 THEN 控制台 SHALL 在 100ms 内暂停播放并记录当前位置
2. WHEN 操作员点击继续按钮 THEN 控制台 SHALL 从暂停位置无缝继续播放
3. WHEN 操作员点击跳至下一段按钮 THEN 控制台 SHALL 立即停止当前片段并开始下一片段
4. WHEN 操作员保存断点 THEN 控制台 SHALL 记录当前播放位置供后续快速恢复
5. WHEN 操作员批量清除断点 THEN 控制台 SHALL 删除所有选中的已保存断点

### 需求 3

**用户故事:** 作为舞台音效操作员，我希望能够随时触发音效，以便配合演员动作和剧情需要。

#### 验收标准

1. WHEN 操作员点击音效按钮 THEN 控制台 SHALL 在 50ms 内开始播放对应音效
2. WHEN 操作员再次点击正在播放的音效按钮 THEN 控制台 SHALL 立即停止该音效
3. WHILE 音效播放中 THEN 控制台 SHALL 保持 BGM 播放状态不受影响
4. WHILE 多个音效同时触发 THEN 控制台 SHALL 同时播放所有触发的音效

### 需求 4

**用户故事:** 作为舞台音效操作员，我希望在手动模式下完全控制单个音频，以便根据演出实际进度灵活调整。

#### 验收标准

1. WHEN 操作员在手动模式选择音频 THEN 控制台 SHALL 加载完整音频并显示总时长
2. WHEN 操作员指定入点并播放 THEN 控制台 SHALL 从指定位置开始播放直到音频结束或手动停止
3. WHEN 操作员设置前置静音 THEN 控制台 SHALL 在播放前执行指定时长的静音等待
4. WHEN 静音等待中操作员点击跳过 THEN 控制台 SHALL 立即结束静音并开始播放
5. WHEN 预设提示时长到达 THEN 控制台 SHALL 显示醒目的下一条提示按钮
6. WHEN 音频播放完成 THEN 控制台 SHALL 停止播放并高亮显示下一条目

### 需求 5

**用户故事:** 作为舞台音效操作员，我希望管理各个音频的独立断点，以便在演出中快速跳转到特定位置。

#### 验收标准

1. WHEN 操作员为某音频保存断点 THEN 控制台 SHALL 为该音频独立记录当前播放位置
2. WHEN 操作员选择已保存的断点 THEN 控制台 SHALL 从该位置立即恢复播放
3. WHEN 操作员点击一键清除断点 THEN 控制台 SHALL 删除指定音频的所有断点
4. WHEN 操作员批量选择断点并清除 THEN 控制台 SHALL 删除所有选中的断点
5. WHEN 操作员点击重播按钮 THEN 控制台 SHALL 从音频开头重新播放
6. WHILE 各音频断点存储 THEN 控制台 SHALL 保持各音频断点相互独立

### 需求 6

**用户故事:** 作为舞台音效操作员，我希望实时调节音量，以便根据演出场景动态控制音量大小。

#### 验收标准

1. WHEN 操作员拖动音量滑块 THEN 控制台 SHALL 实时调整播放音量且无可感知延迟
2. WHILE 音量调节中 THEN 控制台 SHALL 保持音频播放连续不中断
3. WHEN 音量值改变 THEN 控制台 SHALL 立即应用新的音量值
4. WHEN 操作员调节 BGM 音量 THEN 控制台 SHALL 独立于音效音量进行调节

### 需求 7

**用户故事:** 作为舞台音效操作员，我希望在自动和手动模式之间无缝切换，以便灵活应对演出变化。

#### 验收标准

1. WHEN 操作员从自动模式切换到手动模式 THEN 控制台 SHALL 在当前音频位置无缝继续
2. WHEN 操作员从手动模式切换到自动模式 THEN 控制台 SHALL 在当前音频位置无缝继续
3. WHILE 模式切换进行中 THEN 控制台 SHALL 保持音频播放零卡顿
4. WHEN 模式切换完成 THEN 控制台 SHALL 同步两种模式的播放状态和进度

### 需求 8

**用户故事:** 作为舞台音效操作员，我希望系统能够可靠地处理音频文件和状态数据，以便确保演出顺利进行。

#### 验收标准

1. WHEN 控制台加载音频文件 THEN 控制台 SHALL 正确解析 MP3 和 M4A 格式
2. WHEN 控制台序列化播放状态 THEN 控制台 SHALL 能够正确反序列化恢复状态
3. WHEN 控制台保存断点数据 THEN 控制台 SHALL 能够正确加载已保存的断点数据
4. WHEN 控制台启动时 THEN 控制台 SHALL 自动加载上次保存的断点和配置

### 需求 9

**用户故事:** 作为舞台剧导演或音效设计师，我希望使用配置工具创建 Cue 列表，以便提前规划演出音频序列。

#### 验收标准

1. WHEN 用户启动配置工具 THEN 配置工具 SHALL 提供可视化的 Cue 列表编辑界面
2. WHEN 用户添加音频 Cue THEN 配置工具 SHALL 允许设置入点、出点和静音间隔
3. WHEN 用户调整 Cue 顺序 THEN 配置工具 SHALL 支持拖拽排序
4. WHEN 用户保存配置 THEN 配置工具 SHALL 将配置导出为 JSON 格式文件
5. WHEN 控制台加载配置文件 THEN 控制台 SHALL 正确解析并应用 Cue 列表配置

### 需求 10

**用户故事:** 作为舞台音效操作员，我希望在手动模式下 BGM 和音效遵循正确的播放规则，以便符合舞台剧的音频需求。

#### 验收标准

1. WHILE BGM 播放中 THEN 控制台 SHALL 允许任意数量的音效同时播放
2. WHEN 操作员播放新 BGM THEN 控制台 SHALL 停止当前 BGM 并自动保存其断点
3. WHEN 当前 BGM 被新 BGM 打断 THEN 控制台 SHALL 记录被打断 BGM 的播放位置作为断点
4. WHEN 操作员选择被打断 BGM 的断点 THEN 控制台 SHALL 从断点位置恢复播放
5. WHILE 多个音效触发 THEN 控制台 SHALL 允许所有音效同时播放互不干扰

### 需求 11

**用户故事:** 作为舞台音效操作员，我希望界面垂直布局简明清晰，以便在演出中快速准确地执行操作。

#### 验收标准

1. WHEN 控制台显示界面 THEN 控制台 SHALL 采用垂直布局清晰区分各功能区域
2. WHEN 音频正在播放 THEN 控制台 SHALL 显示实时进度条和剩余时间
3. WHEN 操作员使用键盘快捷键 THEN 控制台 SHALL 执行对应的播放控制操作
4. WHEN 当前 Cue 即将结束 THEN 控制台 SHALL 高亮显示下一个待播放的 Cue
5. WHILE 演出进行中 THEN 控制台 SHALL 保持界面响应流畅无卡顿
6. WHEN 需要用户交互 THEN 控制台 SHALL 在主界面内完成交互而非弹出对话框

### 需求 12

**用户故事:** 作为舞台音效操作员，我希望高危操作需要长按确认，以便防止演出中的误操作。

#### 验收标准

1. WHEN 操作员点击播放按钮 THEN 控制台 SHALL 要求长按 500ms 后才执行播放
2. WHEN 操作员点击暂停按钮 THEN 控制台 SHALL 要求长按 500ms 后才执行暂停
3. WHEN 操作员切换配置文件 THEN 控制台 SHALL 要求长按 500ms 后才执行切换
4. WHEN 操作员点击关闭主程序 THEN 控制台 SHALL 显示二次确认界面
5. IF 长按时间不足 THEN 控制台 SHALL 取消该操作并显示提示

### 需求 13

**用户故事:** 作为舞台音效操作员，我希望系统采用异步非阻塞架构，以便确保界面始终响应流畅。

#### 验收标准

1. WHILE 音频加载中 THEN 控制台 SHALL 保持界面响应不阻塞
2. WHILE 文件读写中 THEN 控制台 SHALL 使用异步操作不阻塞主线程
3. WHILE 音频播放中 THEN 控制台 SHALL 在独立线程处理音频不影响 UI
4. WHEN 执行耗时操作 THEN 控制台 SHALL 显示非阻塞的状态指示
5. WHILE 任何操作进行中 THEN 控制台 SHALL 保持所有控件可响应

### 需求 14

**用户故事:** 作为舞台技术团队，我希望所有功能都提供 API 接口，以便通过网络远程控制音效系统。

#### 验收标准

1. WHEN 控制台启动 THEN 控制台 SHALL 同时启动 HTTP API 服务
2. WHEN API 收到播放请求 THEN 控制台 SHALL 执行播放操作并同步更新界面
3. WHEN API 收到暂停请求 THEN 控制台 SHALL 执行暂停操作并同步更新界面
4. WHEN API 收到音量调节请求 THEN 控制台 SHALL 调节音量并同步更新界面
5. WHEN API 收到状态查询请求 THEN 控制台 SHALL 返回当前播放状态和进度
6. WHEN 本地 GUI 操作与 API 请求同时发生 THEN 控制台 SHALL 优先执行本地 GUI 操作
7. WHILE API 处理请求 THEN 控制台 SHALL 异步处理不阻塞其他操作

### 需求 15

**用户故事:** 作为舞台技术团队，我希望 API 支持完整的音频管理功能，以便远程管理音频资源。

#### 验收标准

1. WHEN API 收到上传音频请求 THEN 控制台 SHALL 接收并保存音频文件到指定目录
2. WHEN API 收到获取音频列表请求 THEN 控制台 SHALL 返回所有可用音频文件信息
3. WHEN API 收到获取 Cue 列表请求 THEN 控制台 SHALL 返回当前配置的 Cue 列表
4. WHEN API 收到更新 Cue 列表请求 THEN 控制台 SHALL 更新配置并同步界面
5. WHEN API 收到断点管理请求 THEN 控制台 SHALL 执行断点保存或清除操作

### 需求 16

**用户故事:** 作为舞台技术团队，我希望有一个 Tkinter 远程客户端应用，以便在电脑端远程控制音效系统。

#### 验收标准

1. WHEN 用户启动远程客户端 THEN 客户端 SHALL 显示与本地控制台相同的界面布局
2. WHEN 用户配置 API 地址 THEN 客户端 SHALL 连接到指定的控制台服务
3. WHEN 用户在客户端执行操作 THEN 客户端 SHALL 通过 API 发送请求到控制台
4. WHEN 控制台状态变化 THEN 客户端 SHALL 实时同步更新界面显示
5. WHEN 用户上传音频文件 THEN 客户端 SHALL 将文件传输到控制台服务器
6. IF 网络连接断开 THEN 客户端 SHALL 显示连接状态并尝试自动重连

### 需求 17

**用户故事:** 作为舞台技术团队，我希望有一个 Web UI 客户端，以便在手机浏览器上远程控制音效系统。

#### 验收标准

1. WHEN 用户通过浏览器访问控制台地址 THEN 控制台 SHALL 提供响应式 Web UI 界面
2. WHEN Web UI 在手机浏览器打开 THEN Web UI SHALL 自适应移动端屏幕尺寸
3. WHEN 用户在 Web UI 执行操作 THEN Web UI SHALL 通过 API 发送请求到控制台
4. WHEN 控制台状态变化 THEN Web UI SHALL 通过 WebSocket 实时同步更新界面
5. WHEN 用户在 Web UI 上传音频 THEN Web UI SHALL 将文件传输到控制台服务器
6. WHEN Web UI 显示界面 THEN Web UI SHALL 提供与桌面客户端相同的核心功能
7. IF 网络连接断开 THEN Web UI SHALL 显示连接状态并尝试自动重连
8. WHEN Web 服务启动完成 THEN 控制台 SHALL 在独立窗口显示 Web UI 访问地址的二维码
9. WHEN Web 服务启动完成 THEN 控制台 SHALL 在命令行控制台打印 Web UI 访问地址
10. WHILE 二维码窗口显示 THEN 控制台 SHALL 保持主界面正常运行不受干扰
